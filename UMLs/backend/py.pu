@startuml AI

skinparam classAttributeIconSize 0

'=========================
' ğŸ“ app/models/
'-------------------------
' ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨DTOã®å®šç¾©ã‚’é›†ç´„
'=========================
package "app.models.upload_models" {
  ' ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ä»˜éšãƒ¡ã‚¿æƒ…å ±ã‚’ä¿æŒ
  class UploadDTO <<file: upload_models.py>> {
    + file: UploadFile
    + metadata: Dict[str, Any]
  }
}

package "app.models.estimate_models" {
  ' å»ºç‰©ã®æƒ…å ±ã‹ã‚‰è¦‹ç©ã‚‚ã‚Šã‚’è¦æ±‚ã™ã‚‹DTO
  class EstimateRequest <<file: estimate_models.py>> {
    + structure: str
    + area: float
    + floors: int
    + usage: str
    + lat: float
    + lon: float
    + pref_code: str
  }

  ' è¦‹ç©ã‚‚ã‚Šå¿œç­”ã€é‡‘é¡ãƒ»å†…è¨³ãƒ»åœ°ä¾¡å«ã‚€
  class EstimateResponse <<file: estimate_models.py>> {
    + estimated_amount: float
    + breakdown: Dict[str, float]
    + land_price: LandPriceDTO
  }
}

package "app.models.land_price_dto" {
  ' åœ°ä¾¡æƒ…å ±ã®DTOã€‚è¦‹ç©ã‚‚ã‚Šã«å¿…è¦ãªä¾¡æ ¼ã‚„ç”¨é€”ã€è·é›¢ãªã©ã‚’å«ã‚€
  class LandPriceDTO <<file: land_price_dto.py>> {
    + location: str
    + price: float
    + use: Optional[str]
    + year: Optional[int]
    + distance_m: float
    + source: str
  }
}

package "app.models.history_models" {
  ' è¦‹ç©ã‚‚ã‚Šå±¥æ­´ã®1ãƒ¬ã‚³ãƒ¼ãƒ‰ã€‚å…¥åŠ›ãƒ»å‡ºåŠ›ãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿æŒ
  class HistoryRecord <<file: history_models.py>> {
    + id: int
    + request: EstimateRequest
    + response: EstimateResponse
    + timestamp: datetime
  }
}

'=========================
' ğŸ“ app/services/logic/
'-------------------------
' ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº
'=========================
package "app.services.logic.land_price_service" {
  ' åœ°ä¾¡å–å¾—ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚ä½ç½®æƒ…å ±ã‹ã‚‰æœ€å¯„ã‚Šåœ°ä¾¡ã‚’æ¤œç´¢
  interface ILandPriceRepository <<file: land_price_service.py>> {
    + find_nearest(lat: float, lon: float, pref_code: str): LandPriceDTO
  }

  ' Parquet/GeoJSONç­‰ã‹ã‚‰åœ°ä¾¡ã‚’èª­ã¿è¾¼ã¿ã€æœ€å¯„ã‚Šã‚’è¿”ã™å…·ä½“å®Ÿè£…
  class LandPriceRepository <<file: land_price_service.py>> {
    + __init__(data_dir: str)
    + find_nearest(lat: float, lon: float, pref_code: str): LandPriceDTO
  }

  LandPriceRepository ..|> ILandPriceRepository
}

package "app.services.storage.history_repo" {
  ' è¦‹ç©ã‚‚ã‚Šå±¥æ­´ä¿å­˜ç”¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
  interface IHistoryRepository <<file: history_repo.py>> {
    + save(record: HistoryRecord): None
    + list_all(): List[HistoryRecord]
  }

  ' ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯DBã¸å±¥æ­´ã‚’ä¿å­˜ãƒ»å–å¾—ã™ã‚‹å…·ä½“å®Ÿè£…
  class HistoryRepository <<file: history_repo.py>> {
    + __init__(db_url: str)
    + save(record: HistoryRecord): None
    + list_all(): List[HistoryRecord]
  }

  HistoryRepository ..|> IHistoryRepository
}

package "app.services.logic.estimate_logic" {
  ' å»ºç‰©æƒ…å ± + åœ°ä¾¡æƒ…å ± + AI ã‚’ç”¨ã„ã¦è¦‹ç©ã‚‚ã‚Šã‚’è¿”ã™ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
  class EstimateService <<file: estimate_logic.py>> {
    + __init__(lp_repo: ILandPriceRepository, history_repo: IHistoryRepository)
    + estimate(req: EstimateRequest): EstimateResponse
  }

  note right of EstimateService::estimate
    åœ°ä¾¡å–å¾— â†’ æ§‹é€ åˆ¤å®š â†’ é‡‘é¡è¨ˆç®— â†’ å±¥æ­´ä¿å­˜ã¾ã§ã‚’ä¸€è²«ã—ã¦å‡¦ç†
  end note
}

'=========================
' ğŸ“ app/services/ai/
'-------------------------
' AIå‡¦ç†ï¼ˆOCRã€æ§‹é€ æ¨å®šï¼‰ã«ç‰¹åŒ–ã—ãŸã‚¯ãƒ©ã‚¹
'=========================
package "app.services.ai.ocr_processor" {
  ' å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚’è¡Œã†OCRå‡¦ç†
  class OCRProcessor <<file: ocr_processor.py>> {
    + preprocess(file: UploadFile): Image
    + detect_text(img: Image): TextResult
  }

  note right of OCRProcessor
    â€»Tesseractãƒ™ãƒ¼ã‚¹ã®å‡¦ç†æƒ³å®šã€‚
    è£œåŠ©é–¢æ•°: def load_image(), def clean_text() ãªã©
  end note
}

package "app.services.ai.structure_ai" {
  ' OCRã§å¾—ãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å»ºç‰©ã®æ§‹é€ ã‚’äºˆæ¸¬ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«
  class StructureAI <<file: structure_ai.py>> {
    + predict(text: TextResult): StructureResult
  }

  note right of StructureAI
    ãƒ¢ãƒ‡ãƒ«ä¾‹: XGBoostã‚„è»½é‡NNã«ã‚ˆã‚‹åˆ†é¡ã‚¿ã‚¹ã‚¯
  end note
}

'=========================
' ğŸ“ app/routers/
'-------------------------
' FastAPI ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¤
'=========================
package "app.routers.extract_info" {
  ' å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚Šã€OCRâ†’æ§‹é€ äºˆæ¸¬â†’EstimateRequestã«å¤‰æ›
  class ExtractInfoRouter <<file: extract_info.py>> {
    + extract_info(dto: UploadDTO): EstimateRequest
  }
}

package "app.routers.estimate" {
  ' EstimateRequestã‚’å—ã‘å–ã‚Šã€EstimateResponseã‚’è¿”ã™ãƒ«ãƒ¼ãƒˆ
  class EstimateRouter <<file: estimate.py>> {
    + perform_estimate(req: EstimateRequest): EstimateResponse
  }
}

package "app.routers.land_price" {
  ' ç·¯åº¦çµŒåº¦ãƒ»éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸåœ°ä¾¡æƒ…å ±ã‚’è¿”ã™ãƒ«ãƒ¼ãƒˆ
  class LandPriceRouter <<file: land_price.py>> {
    + get_land_price(lat: float, lon: float, pref_code: str): LandPriceDTO
  }

  note right of LandPriceRouter
    é–¢æ•°ã®ã¿ã®å ´åˆ:
    - def get_land_price(...)
  end note
}

'=========================
' é–¢ä¿‚å®šç¾©
'=========================
ExtractInfoRouter --> OCRProcessor : uses
OCRProcessor --> StructureAI : uses
ExtractInfoRouter --> EstimateRouter : passes EstimateRequest

EstimateRouter --> EstimateService : calls estimate(req)
EstimateService --> ILandPriceRepository : uses
EstimateService --> IHistoryRepository : uses

LandPriceRouter --> ILandPriceRepository : uses

EstimateResponse --> LandPriceDTO
HistoryRecord --> EstimateRequest
HistoryRecord --> EstimateResponse
EstimateService --> LandPriceDTO

@enduml